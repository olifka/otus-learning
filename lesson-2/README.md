# OTUS Learning
# Урок 3 " Файловые системы и LVM "


# Задача:

на имеющемся образе
/dev/mapper/VolGroup00-LogVol00 38G 738M 37G 2% /

уменьшить том под / до 8G
выделить том под /home
выделить том под /var
/var - сделать в mirror
/home - сделать том для снэпшотов
прописать монтирование в fstab
попробовать с разными опциями и разными файловыми системами ( на выбор)
- сгенерить файлы в /home/
- снять снэпшот
- удалить часть файлов
- восстановиться со снэпшота


# Решение:

Vagrantfile, после запуска образа директивой "config.vm.provision :shell, path: "bootstrap.sh"" запускает скрипт bootstrap.sh, находящийся в папке проекта. Этот скрипт, в свою очередь, создаёт новый lvm-том, копирует на него содиржимое корня, формирует скрипт grub_installer.sh
grub_installer.sh нужен для того, чтобы в chroot'е обновить конфигурацию grub и сгенерировать новый образ initrd

Далее для автоматизации уменьшения старого lvm-тома и повторного загрузки системы со старого диска я решил использовать файл /etc/rc.local. bootstrap.sh формирует его

/etc/rc.local уменьшает размер "родного" lvm-тома и производит обратный процесс переноса системы на него

Остальные шаги задачи решены за счёт скриптов create_lvm.sh и create_snapshot.sh (находятся в папке проекта)
create_lvm.sh - создаёт логические тома для /var и /home (var создаётся с ключом -m1), синхронизирует их содержимое с родными директориями, правит fstab и перемонтирует систему на новые разделы (mount -a)

create_snapshot.sh - создаёт в папке /home/vagrant тестовые файлы, создаёт раздел со снэпшотом, удаляет тестовые файлы, запускает мердж снэпшота и ребутает систему. Как результат, после ребута в хомяке видно все созданные нами файлы (в т.ч. удалённые на одном из шагов)

# HOWTO
После выполнения команды vagrant up дождаться, когда система перезагрузиться несколько раз и повиснет на окне логина
Если после vagrant ssh + lsblk внутри ВМ корень будет смонтирован на диск /dev/sde - значит Вы поторопились. Надо просто ещё раз сделать reboot. Корень должен находиться на /dev/sda, наче следующие скрипты отработают некорректно

Далее, после успешного переноса системы на уменьшенный lvm, внутри ВМ надо поочерёдно выполнить команды:
1) sudo bash /vagrant/create_lvm.sh
2) sudo bash /vagrant/create_snapshot.sh
